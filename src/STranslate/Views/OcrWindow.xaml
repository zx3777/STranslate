<Window
    x:Class="STranslate.Views.OcrWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:cnvt="clr-namespace:STranslate.Converters"
    xmlns:control="clr-namespace:STranslate.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:ikw="http://schemas.inkore.net/lib/ui/wpf"
    xmlns:local="clr-namespace:STranslate.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:s="https://github.com/zggsong/2022/xaml"
    xmlns:ui="http://schemas.inkore.net/lib/ui/wpf/modern"
    xmlns:vm="clr-namespace:STranslate.ViewModels"
    x:Name="STOcrWindow"
    Title="{DynamicResource Ocr}"
    Width="{Binding Settings.OcrWindowWidth, Mode=TwoWay}"
    Height="{Binding Settings.OcrWindowHeight, Mode=TwoWay}"
    MinWidth="550"
    MinHeight="500"
    control:SnackbarBehavior.EnableSnackbar="True"
    d:DataContext="{d:DesignInstance Type=vm:OcrWindowViewModel,
                                     IsDesignTimeCreatable=False}"
    d:Width="600"
    ui:TitleBar.ExtendViewIntoTitleBar="True"
    ui:TitleBar.Height="48"
    ui:WindowHelper.SystemBackdropType="Mica"
    ui:WindowHelper.UseModernWindowStyle="True"
    Icon="/Resources/app.ico"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Window.InputBindings>
        <KeyBinding
            Key="Esc"
            Command="{Binding CancelCommand}"
            CommandParameter="{Binding ElementName=STOcrWindow}" />
        <KeyBinding
            Key="{Binding HotkeySettings.ReExecuteOcrHotkey.Key, Converter={cnvt:StringToKeyBindingConverter}, ConverterParameter={x:Static cnvt:HotkeyMode.Key}}"
            Command="{Binding ReExecuteCommand}"
            Modifiers="{Binding HotkeySettings.ReExecuteOcrHotkey.Key, Converter={cnvt:StringToKeyBindingConverter}, ConverterParameter={x:Static cnvt:HotkeyMode.Modifiers}}" />
        <KeyBinding
            Key="{Binding HotkeySettings.QrCodeHotkey.Key, Converter={cnvt:StringToKeyBindingConverter}, ConverterParameter={x:Static cnvt:HotkeyMode.Key}}"
            Command="{Binding QrCodeCommand}"
            Modifiers="{Binding HotkeySettings.QrCodeHotkey.Key, Converter={cnvt:StringToKeyBindingConverter}, ConverterParameter={x:Static cnvt:HotkeyMode.Modifiers}}" />
    </Window.InputBindings>
    <Grid>
        <Border
            Height="48"
            Margin="20,0,0,0"
            VerticalAlignment="Top"
            Background="Transparent"
            IsHitTestVisible="True">
            <ikw:SimpleStackPanel Orientation="Horizontal" Spacing="10">
                <Image Width="20" Source="pack://application:,,,/Resources/app.ico" />
                <TextBlock
                    VerticalAlignment="Center"
                    Text="{DynamicResource Ocr}"
                    TextWrapping="NoWrap" />
            </ikw:SimpleStackPanel>
        </Border>

        <Grid Margin="10,48,10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition d:Width="0">
                    <ColumnDefinition.Style>
                        <Style TargetType="ColumnDefinition">
                            <Setter Property="Width" Value="8" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Settings.IsOcrShowingTextControl}" Value="False">
                                    <Setter Property="Width" Value="0" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ColumnDefinition.Style>
                </ColumnDefinition>
                <ColumnDefinition d:Width="0">
                    <ColumnDefinition.Style>
                        <Style TargetType="ColumnDefinition">
                            <Setter Property="Width" Value="*" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Settings.IsOcrShowingTextControl}" Value="False">
                                    <Setter Property="Width" Value="0" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ColumnDefinition.Style>
                </ColumnDefinition>
            </Grid.ColumnDefinitions>

            <!--#region 左侧图片-->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="48" />
                </Grid.RowDefinitions>

                <Border
                    Background="{DynamicResource {x:Static ui:ThemeKeys.CardBackgroundFillColorDefaultBrushKey}}"
                    BorderBrush="{DynamicResource {x:Static ui:ThemeKeys.CardStrokeColorDefaultBrushKey}}"
                    BorderThickness="1"
                    CornerRadius="{DynamicResource {x:Static ui:ThemeKeys.ControlCornerRadiusKey}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <ui:InfoBar
                            Title="{DynamicResource NoLocationInfoTitle}"
                            Margin="10"
                            VerticalAlignment="Top"
                            Panel.ZIndex="1000"
                            IsOpen="{Binding IsNoLocationInfoVisible, Mode=TwoWay}"
                            Message="{DynamicResource NoLocationInfoMessage}"
                            Severity="Warning" />

                        <control:ImageZoom
                            x:Name="PART_ImageZoom"
                            MaxZoomRatio="5.0"
                            MinZoomRatio="0.1"
                            OcrWords="{Binding OcrWords}"
                            Source="{Binding DisplayImage}">
                            <control:ImageZoom.InputBindings>
                                <KeyBinding
                                    Key="A"
                                    Command="{Binding SelectAllTextCommand}"
                                    CommandParameter="{Binding ElementName=PART_ImageZoom}"
                                    Modifiers="Ctrl" />
                                <KeyBinding
                                    Key="C"
                                    Command="{Binding CopyImageOrTextCommand}"
                                    CommandParameter="{Binding ElementName=PART_ImageZoom}"
                                    Modifiers="Ctrl" />
                                <KeyBinding
                                    Key="V"
                                    Command="{Binding OpenClipboardImageCommand}"
                                    Modifiers="Ctrl" />
                            </control:ImageZoom.InputBindings>
                            <control:ImageZoom.Resources>
                                <s:BindingProxy x:Key="ViewModelProxy" Data="{Binding}" />
                                <s:BindingProxy x:Key="ImageZoomProxy" Data="{Binding ElementName=PART_ImageZoom}" />
                            </control:ImageZoom.Resources>
                            <control:ImageZoom.ContextMenu>
                                <ContextMenu>
                                    <MenuItem
                                        Command="{Binding Source={StaticResource ViewModelProxy}, Path=Data.CopyImageOrTextCommand}"
                                        CommandParameter="{Binding Source={StaticResource ImageZoomProxy}, Path=Data}"
                                        Header="{DynamicResource Copy}">
                                        <MenuItem.Style>
                                            <Style BasedOn="{StaticResource {x:Type MenuItem}}" TargetType="MenuItem">
                                                <Setter Property="Icon">
                                                    <Setter.Value>
                                                        <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.Copy_20_Regular}" />
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Source={StaticResource ImageZoomProxy}, Path=Data.SelectedText, Converter={cnvt:StringToBoolConverter}}" Value="True">
                                                        <Setter Property="Icon">
                                                            <Setter.Value>
                                                                <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.ImageCopy_20_Regular}" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <MenuItem
                                        Command="{Binding Source={StaticResource ViewModelProxy}, Path=Data.SelectAllTextCommand}"
                                        CommandParameter="{Binding Source={StaticResource ImageZoomProxy}, Path=Data}"
                                        Header="{DynamicResource SelectAll}">
                                        <MenuItem.Icon>
                                            <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.SelectAllOn_20_Regular}" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator />
                                    <MenuItem Command="{Binding Source={StaticResource ViewModelProxy}, Path=Data.OpenClipboardImageCommand}" Header="{DynamicResource ImportFromClipboard}">
                                        <MenuItem.Icon>
                                            <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.ClipboardImage_20_Regular}" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Command="{Binding Source={StaticResource ViewModelProxy}, Path=Data.OpenImageFileCommand}" Header="{DynamicResource ImportFromFile}">
                                        <MenuItem.Icon>
                                            <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.Image_20_Regular}" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator />
                                    <MenuItem Command="{Binding Source={StaticResource ViewModelProxy}, Path=Data.SaveImageCommand}" Header="{DynamicResource SaveAs}">
                                        <MenuItem.Icon>
                                            <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.SaveImage_20_Regular}" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator />
                                    <MenuItem Command="{Binding Source={StaticResource ViewModelProxy}, Path=Data.ToggleTextControlCommand}">
                                        <MenuItem.Style>
                                            <Style BasedOn="{StaticResource {x:Type MenuItem}}" TargetType="MenuItem">
                                                <Setter Property="Header" Value="{DynamicResource ShowText}" />
                                                <Setter Property="Icon">
                                                    <Setter.Value>
                                                        <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.PanelRightContract_20_Regular}" />
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Source={StaticResource ViewModelProxy}, Path=Data.Settings.IsOcrShowingTextControl}" Value="True">
                                                        <Setter Property="Header" Value="{DynamicResource HideText}" />
                                                        <Setter Property="Icon">
                                                            <Setter.Value>
                                                                <ui:FontIcon Icon="{x:Static ui:FluentSystemIcons.PanelLeftContract_20_Regular}" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                </ContextMenu>
                            </control:ImageZoom.ContextMenu>
                        </control:ImageZoom>

                        <Grid Grid.Row="1" Margin="5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>
                            <ikw:SimpleStackPanel
                                VerticalAlignment="Bottom"
                                Orientation="Horizontal"
                                Spacing="5">
                                <control:IconButton
                                    Command="{Binding SaveImageCommand}"
                                    Icon="{x:Static ui:FluentSystemIcons.SaveImage_20_Regular}"
                                    ToolTip="{DynamicResource SaveAs}" />

                                <control:IconButton
                                    Margin="5,0,0,0"
                                    Command="{Binding OpenClipboardImageCommand}"
                                    Icon="{x:Static ui:FluentSystemIcons.ClipboardImage_20_Regular}"
                                    ToolTip="{DynamicResource ImportFromClipboard}" />
                                <control:IconButton
                                    Command="{Binding OpenImageFileCommand}"
                                    Icon="{x:Static ui:FluentSystemIcons.Image_20_Regular}"
                                    ToolTip="{DynamicResource ImportFromFile}" />
                            </ikw:SimpleStackPanel>

                            <ikw:SimpleStackPanel
                                Grid.Column="1"
                                VerticalAlignment="Bottom"
                                FlowDirection="RightToLeft"
                                Orientation="Horizontal"
                                Spacing="5">
                                <control:IconButton
                                    Icon="{x:Static ui:FluentSystemIcons.ImageSplit_20_Regular}"
                                    IsOn="{Binding Settings.IsOcrShowingAnnotated}"
                                    ToolTip="{DynamicResource ShowHideAnnotation}"
                                    Type="Toggle" />
                                <control:IconButton
                                    Command="{Binding FitToWindowSizeCommand}"
                                    CommandParameter="{Binding ElementName=PART_ImageZoom}"
                                    Icon="{x:Static ui:FluentSystemIcons.ZoomFit_20_Regular}"
                                    ToolTip="{DynamicResource FitToWindow}"
                                    Visibility="{Binding IsShowingFitToWindow, Converter={cnvt:BoolToVisibilityConverter}}" />
                                <control:IconButton
                                    Command="{Binding FitToActualSizeCommand}"
                                    CommandParameter="{Binding ElementName=PART_ImageZoom}"
                                    Icon="{x:Static ui:FluentSystemIcons.ScaleFit_20_Regular}"
                                    ToolTip="{DynamicResource ActualSize}"
                                    Visibility="{Binding IsShowingFitToWindow, Converter={cnvt:BoolToVisibilityInverseConverter}}" />
                                <control:IconButton
                                    Command="{Binding ZoomOutCommand}"
                                    CommandParameter="{Binding ElementName=PART_ImageZoom}"
                                    Icon="{x:Static ui:FluentSystemIcons.ZoomOut_20_Regular}" />
                                <control:IconButton
                                    Command="{Binding ZoomInCommand}"
                                    CommandParameter="{Binding ElementName=PART_ImageZoom}"
                                    Icon="{x:Static ui:FluentSystemIcons.ZoomIn_20_Regular}" />
                            </ikw:SimpleStackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <ikw:SimpleStackPanel
                    Grid.Row="1"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Orientation="Horizontal"
                    Spacing="8">
                    <Button Command="{Binding OpenSettingsCommand}">
                        <ui:IconAndText Content="{DynamicResource Settings}" Icon="{x:Static ui:FluentSystemIcons.Settings_20_Regular}" />
                    </Button>
                    <ComboBox
                        MinWidth="120"
                        MaxWidth="200"
                        DisplayMemberPath="DisplayName"
                        ItemsSource="{Binding OcrEngines}"
                        SelectedItem="{Binding SelectedOcrEngine}" />
                    <ComboBox
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"
                        DisplayMemberPath="Display"
                        ItemsSource="{Binding DataProvider.LangEnums}"
                        SelectedValue="{Binding Settings.OcrLanguage}"
                        SelectedValuePath="Value" />
                    <Button Command="{Binding ToggleTextControlCommand}">
                        <Button.Style>
                            <Style BasedOn="{StaticResource {x:Type Button}}" TargetType="Button">
                                <Setter Property="Content">
                                    <Setter.Value>
                                        <ui:IconAndText Content="{DynamicResource ShowText}" Icon="{x:Static ui:FluentSystemIcons.PanelRightContract_20_Regular}" />
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Settings.IsOcrShowingTextControl}" Value="True">
                                        <Setter Property="Content">
                                            <Setter.Value>
                                                <ui:IconAndText Content="{DynamicResource HideText}" Icon="{x:Static ui:FluentSystemIcons.PanelLeftContract_20_Regular}" />
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    <Button Command="{Binding ReExecuteCommand}" ToolTip="{Binding HotkeySettings.ReExecuteOcrHotkey}">
                        <ui:IconAndText Content="{DynamicResource Recognize}" Icon="{x:Static ui:FluentSystemIcons.TextEffectsSparkle_20_Regular}" />
                    </Button>
                </ikw:SimpleStackPanel>
            </Grid>
            <!--#endregion-->

            <!--#region 右侧文本-->
            <Grid Grid.Column="2" Visibility="{Binding Settings.IsOcrShowingTextControl, Converter={cnvt:BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="48" />
                </Grid.RowDefinitions>
                <Border
                    Background="{DynamicResource {x:Static ui:ThemeKeys.CardBackgroundFillColorDefaultBrushKey}}"
                    BorderBrush="{DynamicResource {x:Static ui:ThemeKeys.CardStrokeColorDefaultBrushKey}}"
                    BorderThickness="1"
                    CornerRadius="{DynamicResource {x:Static ui:ThemeKeys.ControlCornerRadiusKey}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="2*" />
                            <RowDefinition>
                                <RowDefinition.Style>
                                    <Style TargetType="RowDefinition">
                                        <Setter Property="Height" Value="*" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding QrCodeResult}" Value="">
                                                <Setter Property="Height" Value="Auto" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </RowDefinition.Style>
                            </RowDefinition>
                        </Grid.RowDefinitions>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <TextBox
                                x:Name="PART_TextBox"
                                ui:TextBoxHelper.IsDeleteButtonVisible="False"
                                AcceptsReturn="True"
                                AcceptsTab="True"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="0"
                                Text="{Binding Result, UpdateSourceTrigger=PropertyChanged}"
                                TextWrapping="Wrap"
                                VerticalScrollBarVisibility="Auto" />
                            <ikw:SimpleStackPanel
                                Grid.Row="1"
                                Margin="5"
                                VerticalAlignment="Bottom"
                                Orientation="Horizontal"
                                Spacing="5"
                                Visibility="{Binding Result, Converter={cnvt:EqualToVisibilityInverseConverter}}">
                                <control:IconButton
                                    Padding="5,3"
                                    Command="{Binding PlayAudioCommand}"
                                    CommandParameter="{Binding Result}"
                                    Icon="{x:Static ui:FluentSystemIcons.Speaker2_24_Regular}"
                                    IconSize="14" />
                                <control:IconButton
                                    Padding="5,3"
                                    Command="{Binding CopyCommand}"
                                    CommandParameter="{Binding Result}"
                                    Icon="{x:Static ui:FluentSystemIcons.Copy_24_Regular}"
                                    IconSize="14" />
                                <control:IconButton
                                    Padding="5,3"
                                    Command="{Binding RemoveLineBreaksCommand}"
                                    CommandParameter="{Binding ElementName=PART_TextBox}"
                                    Icon="{x:Static ui:FluentSystemIcons.TextWrap_24_Regular}"
                                    IconSize="14"
                                    ToolTip="{DynamicResource RemoveLineBreak}" />
                                <control:IconButton
                                    Padding="5,3"
                                    Command="{Binding RemoveSpacesCommand}"
                                    CommandParameter="{Binding ElementName=PART_TextBox}"
                                    Icon="{x:Static ui:FluentSystemIcons.Spacebar_24_Regular}"
                                    IconSize="14"
                                    ToolTip="{DynamicResource RemoveSpace}" />
                            </ikw:SimpleStackPanel>
                        </Grid>

                        <Separator
                            Grid.Row="0"
                            Margin="0,3,0,0"
                            VerticalAlignment="Bottom"
                            Background="{StaticResource {x:Static ui:ThemeKeys.ContentDialogSeparatorBorderBrushKey}}"
                            Visibility="{Binding QrCodeResult, Converter={cnvt:EqualToVisibilityInverseConverter}}" />

                        <Grid Grid.Row="1" Visibility="{Binding QrCodeResult, Converter={cnvt:EqualToVisibilityInverseConverter}}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <TextBox
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="0"
                                IsReadOnly="True"
                                Text="{Binding QrCodeResult}"
                                TextWrapping="Wrap" />
                            <ikw:SimpleStackPanel
                                Grid.Row="1"
                                Margin="5"
                                VerticalAlignment="Bottom"
                                Orientation="Horizontal"
                                Spacing="5">
                                <control:IconButton
                                    Command="{Binding CopyCommand}"
                                    CommandParameter="{Binding QrCodeResult}"
                                    Icon="{x:Static ui:FluentSystemIcons.Copy_20_Regular}"
                                    ToolTip="{DynamicResource Copy}" />
                            </ikw:SimpleStackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <ikw:SimpleStackPanel
                    Grid.Row="1"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Orientation="Horizontal"
                    Spacing="8">
                    <Button Command="{Binding QrCodeCommand}" ToolTip="{Binding HotkeySettings.QrCodeHotkey}">
                        <ui:IconAndText Content="{DynamicResource RecognizeQrCode}" Icon="{x:Static ui:FluentSystemIcons.QrCode_20_Regular}" />
                    </Button>
                    <Button Command="{Binding TranslateCommand}">
                        <ui:IconAndText Content="{DynamicResource Translate}" Icon="{x:Static ui:FluentSystemIcons.Translate_20_Regular}" />
                    </Button>
                </ikw:SimpleStackPanel>
            </Grid>
            <!--#endregion-->
        </Grid>

        <!--#region 蒙版层-->
        <Border
            x:Name="PART_LoadingMask"
            Margin="0,48,0,0"
            Background="#B0000000"
            IsHitTestVisible="{Binding IsExecuting}"
            Visibility="{Binding IsExecuting, Converter={cnvt:BoolToVisibilityConverter}}">
            <Border.OpacityMask>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Offset="0" Color="#FF000000" />
                    <GradientStop Offset="0.5" Color="#C0000000" />
                    <GradientStop Offset="1" Color="#FF000000" />
                </LinearGradientBrush>
            </Border.OpacityMask>

            <StackPanel
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Orientation="Vertical">
                <ui:ProgressRing
                    x:Name="PART_ProgressRing"
                    Width="60"
                    Height="60"
                    Margin="0,0,0,16"
                    IsActive="{Binding IsExecuting}" />

                <TextBlock
                    HorizontalAlignment="Center"
                    FontSize="{DynamicResource STControlFontSize15}"
                    FontWeight="Medium"
                    Foreground="White"
                    Text="{Binding ProcessRingText}"
                    TextAlignment="Center" />
            </StackPanel>
        </Border>
        <!--#endregion-->
    </Grid>
</Window>